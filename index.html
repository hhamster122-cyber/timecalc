<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time Converter</title>
  <style>
    :root { --bg:#f8fafc; --fg:#0f172a; --muted:#64748b; --card:#fff; --br:#e2e8f0; --pri:#4f46e5; }
    * { box-sizing:border-box; }
    body { margin:0; font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:#0f172a; }
    .wrap { max-width:960px; margin:0 auto; padding:16px; }
    h1 { font-size:22px; margin:0 0 6px; }
    .note { color:var(--muted); margin:0 0 12px; font-size:14px; }
    .section { margin:12px 0; }
    .title { font-weight:700; margin:0 0 8px; font-size:15px; text-transform:uppercase; letter-spacing:.02em; color:#334155; }
    .grid2 { display:grid; gap:12px; grid-template-columns:1fr; }
    .grid3 { display:grid; gap:12px; grid-template-columns:1fr; }
    @media (min-width:800px){ .grid2{ grid-template-columns:1.2fr 1fr; } .grid3{ grid-template-columns:1fr 1fr 1fr; } }
    .card { background:var(--card); border:1px solid var(--br); border-radius:16px; padding:12px; }
    label { display:block; font-weight:600; margin:0 0 6px; font-size:14px; }
    input[type="text"], select { width:100%; border:1px solid var(--br); border-radius:12px; padding:10px 12px; font-size:16px; }
    .row { display:flex; gap:8px; align-items:center; }
    .btn { border:1px solid var(--br); background:#fff; border-radius:12px; padding:10px 14px; font-size:15px; cursor:pointer; }
    .btn:hover { background:#f1f5f9; }
    .zones { height:210px; overflow:auto; border:1px solid var(--br); border-radius:12px; }
    .zones button { display:block; width:100%; border:0; background:transparent; text-align:left; padding:10px 12px; font-size:14px; cursor:pointer; }
    .zones button:hover { background:#f8fafc; }
    .zones button.active { background:#eef2ff; font-weight:600; }
    .muted { color:var(--muted); font-size:13px; }
    .big { font-size:20px; font-weight:700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .break { word-break:break-all; }
    .warn { color:#b91c1c; }
    .tabs { display:flex; gap:8px; margin:6px 0 8px; }
    .tab { padding:6px 10px; border:1px solid var(--br); border-radius:999px; cursor:pointer; font-size:13px; user-select:none; }
    .tab.active { background:#eef2ff; font-weight:600; }
    .hidden { display:none; }
    .actions { position:sticky; bottom:0; background:rgba(248,250,252,.88); backdrop-filter:saturate(1.2) blur(6px); padding:10px; border-top:1px solid var(--br); display:flex; gap:8px; justify-content:flex-end; border-radius:0 0 16px 16px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#1f2a6b; font-size:12px; margin-left:6px; }
    .chip { display:inline-block; padding:2px 8px; border-radius:999px; background:#e2e8f0; color:#0f172a; font-size:12px; }
    .picker { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .picker .field { min-width:96px; flex:1; }
    .sep { padding:0 4px; font-weight:700; color:#334155; }
    .timewrap { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .timewrap .field { width:110px; }
    @media (max-width:799px){
      .wrap { padding:10px; }
      input, select, .btn { min-height:44px; }
      .zones { height:240px; }
      .picker .field { min-width:88px; }
    }
    .count { font-size:14px; color:#334155; margin-top:6px; }
    .count strong { font-weight:700; }
  </style>
</head>
<body>
  <main class="wrap">
    <header class="section">
      <h1 id="title">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–∏: UTC ‚Üí –≤–∞—à —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å</h1>
      <div id="note" class="note">–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è –ø–æ UTC ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –º–µ—Å—Ç–Ω–æ–µ –≤—Ä–µ–º—è. –£—á—ë—Ç –ª–µ—Ç–Ω–µ–≥–æ/–∑–∏–º–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π.</div>
    </header>

    <section class="section">
      <div class="title" id="title_conv">–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è</div>
      <div class="grid2">
        <div class="card">
          <label id="label_input">–í—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è (UTC)</label>
          <div class="tabs">
            <div id="tabPicker" class="tab active">–ü—Ä–æ–∫—Ä—É—Ç–∫–∞</div>
            <div id="tabText" class="tab">–í–≤–æ–¥</div>
          </div>

          <div id="pickerBox">
            <div id="datePicker" class="picker"></div>
            <div class="timewrap">
              <div class="field"><select id="hh"></select></div>
              <span>:</span>
              <div class="field"><select id="mm"></select></div>
            </div>
            <p class="muted" id="hint_picker">–î–∞—Ç–∞/–≤—Ä–µ–º—è —Ç—Ä–∞–∫—Ç—É—é—Ç—Å—è –∫–∞–∫ UTC.</p>
          </div>

          <div id="textBox" class="hidden">
            <input id="utcInput" type="text" inputmode="numeric" placeholder="01.12.2025 18:30" />
            <p id="hint_input" class="muted">–§–æ—Ä–º–∞—Ç: <span id="fmtBadge" class="badge mono">–î–î.–ú–ú.–ì–ì–ì–ì HH:mm</span> (–∞–≤—Ç–æ –ø–æ —Ä–µ–≥–∏–æ–Ω—É). –¢–∞–∫–∂–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è ISO <span class="mono">2025-11-05T14:00</span>.</p>
            <p id="input_err" class="muted warn" style="display:none;"></p>
          </div>
        </div>

        <div class="card">
          <label id="label_result">–†–µ–∑—É–ª—å—Ç–∞—Ç <span id="tzChip" class="chip"></span></label>
          <div id="outLocal" class="big" aria-live="polite">‚Äî</div>
          <div id="outTz" class="muted mono"></div>
          <div class="muted" style="margin-top:6px;"><span id="label_now">–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è:</span> <span id="outNow"></span></div>
          <div id="countdown" class="count"></div>
          <div class="actions">
            <button class="btn" id="btnCopy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            <button class="btn" id="btnOpen">–û—Ç–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="title" id="title_setup">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      <div class="grid3">
        <div class="card">
          <label id="label_tz">–í–∞—à —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å <span id="tzCurrent" class="chip"></span></label>
          <div class="row" style="margin-bottom:8px;">
            <input id="tzSearch" type="text" placeholder="–ü–æ–∏—Å–∫ (Europe/Moscow, America/New_York‚Ä¶)" />
            <button class="btn" id="btnAuto">–ê–≤—Ç–æ</button>
          </div>
          <div class="zones" id="zoneList"></div>
        </div>

        <div class="card">
          <label id="label_lang">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</label>
          <select id="lang">
            <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
            <option value="en">üá¨üáß English</option>
            <option value="es">üá™üá∏ Espa√±ol</option>
            <option value="it">üáÆüáπ Italiano</option>
            <option value="nl">üá≥üá± Nederlands</option>
          </select>
          <p class="muted" id="hint_lang">–¢–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∏ –∏ —Ñ–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ –º–µ–Ω—è—é—Ç—Å—è –ø–æ —è–∑—ã–∫—É.</p>
        </div>

        <div class="card">
          <label id="label_df">–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã (–≤–≤–æ–¥/–ø—Ä–æ–∫—Ä—É—Ç–∫–∞)</label>
          <select id="dateFormat">
            <option value="auto">–ê–≤—Ç–æ (–ø–æ —Ä–µ–≥–∏–æ–Ω—É)</option>
            <option value="MDY">MM/DD/YYYY</option>
            <option value="DMY">DD/MM/YYYY</option>
            <option value="D.M.Y">DD.MM.YYYY</option>
            <option value="YMD">YYYY-MM-DD</option>
          </select>
          <p class="muted" id="hint_df">–í—ã–±–æ—Ä –≤–ª–∏—è–µ—Ç –∏ –Ω–∞ –ø–æ–ª–µ ¬´–í–≤–æ–¥¬ª, –∏ –Ω–∞ ¬´–ü—Ä–æ–∫—Ä—É—Ç–∫—É¬ª.</p>
        </div>
      </div>
    </section>

    <section class="section card">
      <label id="label_share">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</label>
      <div id="share" class="mono break" style="margin:8px 0 8px;"></div>
    </section>
  </main>

  <script>
    const SUPPORTED = ['ru','en','es','it','nl'];
    const DF = { AUTO:'auto', MDY:'MDY', DMY:'DMY', DMY_DOT:'D.M.Y', YMD:'YMD' };

    const DICT = {
      ru: { title:"–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–∏: UTC ‚Üí –≤–∞—à —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å", note:"–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è –ø–æ UTC ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –º–µ—Å—Ç–Ω–æ–µ –≤—Ä–µ–º—è. –£—á—ë—Ç –ª–µ—Ç–Ω–µ–≥–æ/–∑–∏–º–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π.",
            conv:"–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è", setup:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏", input_label:"–í—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è (UTC)", picker_hint:"–î–∞—Ç–∞/–≤—Ä–µ–º—è —Ç—Ä–∞–∫—Ç—É—é—Ç—Å—è –∫–∞–∫ UTC.",
            text_hint:"–§–æ—Ä–º–∞—Ç: {fmt} (–∞–≤—Ç–æ –ø–æ —Ä–µ–≥–∏–æ–Ω—É). –¢–∞–∫–∂–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è ISO 2025-11-05T14:00.", text_err:"–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –¥–∞—Ç—É/–≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ {fmt} (UTC).",
            tz_label:"–í–∞—à —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å", search_placeholder:"–ü–æ–∏—Å–∫ (Europe/Moscow, America/New_York‚Ä¶)", auto_btn:"–ê–≤—Ç–æ", result:"–†–µ–∑—É–ª—å—Ç–∞—Ç",
            current_time:"–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è:", share:"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è", copy:"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É", open:"–û—Ç–∫—Ä—ã—Ç—å", lang_label:"–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞",
            lang_hint:"–¢–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∏ –∏ —Ñ–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ –º–µ–Ω—è—é—Ç—Å—è –ø–æ —è–∑—ã–∫—É.", df_label:"–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã (–≤–≤–æ–¥/–ø—Ä–æ–∫—Ä—É—Ç–∫–∞)", df_hint:"–í—ã–±–æ—Ä –≤–ª–∏—è–µ—Ç –∏ –Ω–∞ –ø–æ–ª–µ ¬´–í–≤–æ–¥¬ª, –∏ –Ω–∞ ¬´–ü—Ä–æ–∫—Ä—É—Ç–∫—É¬ª.",
            tab_picker:"–ü—Ä–æ–∫—Ä—É—Ç–∫–∞", tab_text:"–í–≤–æ–¥",
            left:"–û—Å—Ç–∞–ª–æ—Å—å", passed:"–ü—Ä–æ—à–ª–æ", now:"–°–æ–±—ã—Ç–∏–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å" },
      en: { title:"Time Converter: UTC ‚Üí your time zone", note:"Enter UTC date/time to see your local time. DST is automatic.",
            conv:"Conversion", setup:"Setup", input_label:"Event time (UTC)", picker_hint:"Date/time is treated as UTC.",
            text_hint:"Format: {fmt} (auto by region). ISO 2025-11-05T14:00 is also accepted.", text_err:"Please enter a valid UTC date/time in {fmt}.",
            tz_label:"Your time zone", search_placeholder:"Search (Europe/Moscow, America/New_York‚Ä¶)", auto_btn:"Auto", result:"Result",
            current_time:"Current time:", share:"Share", copy:"Copy link", open:"Open", lang_label:"Interface language",
            lang_hint:"Labels & output follow the language.", df_label:"Date format (input/picker)", df_hint:"Affects both Text and Wheel modes.",
            tab_picker:"Wheel", tab_text:"Text",
            left:"Left", passed:"Passed", now:"Happening now" },
      es: { title:"Conversor de hora: UTC ‚Üí tu zona horaria", note:"Introduce la hora en UTC para ver tu hora local. El horario de verano es autom√°tico.",
            conv:"Conversi√≥n", setup:"Ajustes", input_label:"Hora del evento (UTC)", picker_hint:"La fecha/hora se interpreta como UTC.",
            text_hint:"Formato: {fmt} (auto por regi√≥n). Tambi√©n se acepta ISO 2025-11-05T14:00.", text_err:"Introduce una fecha/hora UTC v√°lida en {fmt}.",
            tz_label:"Tu zona horaria", search_placeholder:"Buscar (Europe/Moscow, America/New_York‚Ä¶)", auto_btn:"Auto", result:"Resultado",
            current_time:"Hora actual:", share:"Compartir", copy:"Copiar enlace", open:"Abrir", lang_label:"Idioma de la interfaz",
            lang_hint:"Las etiquetas y el formato siguen la lengua.", df_label:"Formato de fecha (texto/selector)", df_hint:"Afecta al texto y al selector.",
            tab_picker:"Selector", tab_text:"Texto",
            left:"Queda", passed:"Pasado", now:"Ahora mismo" },
      it: { title:"Convertitore orario: UTC ‚Üí il tuo fuso orario", note:"Inserisci l'orario UTC per vedere l'ora locale. L'ora legale √® automatica.",
            conv:"Conversione", setup:"Impostazioni", input_label:"Orario dell'evento (UTC)", picker_hint:"La data/ora √® considerata UTC.",
            text_hint:"Formato: {fmt} (auto per regione). Accetta anche ISO 2025-11-05T14:00.", text_err:"Inserisci una data/ora UTC valida nel formato {fmt}.",
            tz_label:"Il tuo fuso orario", search_placeholder:"Cerca (Europe/Moscow, America/New_York‚Ä¶)", auto_btn:"Auto", result:"Risultato",
            current_time:"Ora attuale:", share:"Condividi", copy:"Copia link", open:"Apri", lang_label:"Lingua dell'interfaccia",
            lang_hint:"Le etichette e il formato seguono la lingua.", df_label:"Formato data (testo/selettore)", df_hint:"Influisce sia sul testo che sul selettore.",
            tab_picker:"Rotella", tab_text:"Testo",
            left:"Manca", passed:"Trascorso", now:"In corso" },
      nl: { title:"Tijdconverter: UTC ‚Üí jouw tijdzone", note:"Voer de UTC-tijd in om je lokale tijd te zien. Zomertijd is automatisch.",
            conv:"Conversie", setup:"Instellingen", input_label:"Gebeurtenistijd (UTC)", picker_hint:"Datum/tijd wordt als UTC behandeld.",
            text_hint:"Formaat: {fmt} (automatisch per regio). ISO 2025-11-05T14:00 wordt ook geaccepteerd.", text_err:"Voer een geldige UTC-datum/tijd in {fmt} in.",
            tz_label:"Jouw tijdzone", search_placeholder:"Zoeken (Europe/Moscow, America/New_York‚Ä¶)", auto_btn:"Auto", result:"Resultaat",
            current_time:"Huidige tijd:", share:"Delen", copy:"Link kopi√´ren", open:"Openen", lang_label:"Interfacetaal",
            lang_hint:"Labels en formaat volgen de taal.", df_label:"Datumnotatie (tekst/selector)", df_hint:"Van toepassing op beide modi.",
            tab_picker:"Wieltjes", tab_text:"Tekst",
            left:"Resterend", passed:"Verlopen", now:"Nu bezig" }
    };

    let state = {
      tz: getUserTZ(),
      lang: getInitialLang(),
      mode: 'picker',
      dateFormat: DF.AUTO,
      utcISO: isoNowUTCMin(),   // canonical UTC (YYYY-MM-DDTHH:mm)
    };

    const $ = (id)=>document.getElementById(id);

    function init(){
      $('lang').value = state.lang;
      $('lang').addEventListener('change', ()=>{
        state.lang = $('lang').value;
        localStorage.setItem('calc_lang', state.lang);
        applyLang(); updateMaskBadge(); renderOutput();
      });

      $('tabPicker').addEventListener('click', ()=>{ setMode('picker'); syncPickerFromISO(); renderOutput(); });
      $('tabText').addEventListener('click', ()=>{ setMode('text'); syncTextFromISO(); $('utcInput').focus(); renderOutput(); });

      $('btnAuto').addEventListener('click', ()=>{ state.tz = getUserTZ(); onTZChanged(); });
      $('tzSearch').addEventListener('input', (e)=> renderZones(filterZones(e.target.value.trim().toLowerCase())));

      renderZones(allZones());
      readQuery();
      applyLang();
      rebuildPicker();
      syncPickerFromISO();
      syncTextFromISO();
      $('utcInput').addEventListener('input', onManualInputMask);

      $('dateFormat').value = state.dateFormat;
      $('dateFormat').addEventListener('change', ()=>{
        state.dateFormat = $('dateFormat').value;
        rebuildPicker(); syncPickerFromISO(); syncTextFromISO(); updateMaskBadge(); renderOutput();
      });

      setMode(state.mode);
      updateMaskBadge();
      renderOutput();
      setInterval(()=> { updateNow(); updateCountdown(); }, 1000);
    }

    function setMode(m){
      state.mode = m;
      $('tabPicker').classList.toggle('active', m==='picker');
      $('tabText').classList.toggle('active', m==='text');
      $('pickerBox').classList.toggle('hidden', m!=='picker');
      $('textBox').classList.toggle('hidden', m!=='text');
    }

    // Timezones
    function getUserTZ(){ try { return Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC'; } catch { return 'UTC'; } }
    function allZones(){
      try {
        if (typeof Intl.supportedValuesOf === 'function') {
          const list = Intl.supportedValuesOf('timeZone');
          const user = getUserTZ();
          return [user, ...list.filter(z => z !== user)];
        }
      } catch(e){}
      return ['UTC','Europe/Moscow','Europe/London','America/New_York','America/Chicago','America/Denver','America/Los_Angeles','Europe/Amsterdam','Europe/Madrid','Europe/Rome','Asia/Tokyo','Asia/Shanghai','Asia/Dubai','Australia/Sydney'];
    }
    function filterZones(q){ const z = allZones(); return q? z.filter(v=>v.toLowerCase().includes(q)) : z; }
    function renderZones(list){
      const box = $('zoneList'); box.innerHTML='';
      list.forEach(z=>{
        const b=document.createElement('button'); b.textContent=z; if (z===state.tz) b.className='active';
        b.addEventListener('click', ()=>{ state.tz=z; onTZChanged(); });
        box.appendChild(b);
      });
      markTZ();
    }
    function markTZ(){
      [...$('zoneList').querySelectorAll('button')].forEach(b=> b.classList.toggle('active', b.textContent===state.tz));
      $('tzCurrent').textContent = state.tz;
      $('tzChip').textContent = state.tz;
    }
    function onTZChanged(){
      markTZ();
      updateMaskBadge();
      rebuildPicker(); // if AUTO order changes
      syncPickerFromISO();
      syncTextFromISO();
      renderOutput(); // <‚Äî recompute now
    }

    // Date formats
    function inferDfFromTZ(tz){
      if (!tz) return DF.DMY;
      if (tz.startsWith('America/')) return DF.MDY;
      if (tz.startsWith('Europe/')){
        const city = tz.split('/')[1]||'';
        if (['Moscow','Kaliningrad','Samara'].includes(city)) return DF.DMY_DOT;
        return DF.DMY;
      }
      if (tz.startsWith('Asia/')){
        const city = tz.split('/')[1]||'';
        const ymd = ['Tokyo','Seoul','Shanghai','Taipei','Hong_Kong','Singapore'];
        if (ymd.includes(city)) return DF.YMD;
        return DF.DMY;
      }
      return DF.DMY;
    }
    function getActiveDf(){ return state.dateFormat===DF.AUTO ? inferDfFromTZ(state.tz) : state.dateFormat; }
    function getFormatLabel(df){
      switch(df){
        case DF.MDY: return 'MM/DD/YYYY';
        case DF.DMY: return 'DD/MM/YYYY';
        case DF.DMY_DOT: return 'DD.MM.YYYY';
        case DF.YMD: return 'YYYY-MM-DD';
        default: return 'DD/MM/YYYY';
      }
    }
    function updateMaskBadge(){
      const df = getActiveDf();
      const t = DICT[state.lang] || DICT['en'];
      $('fmtBadge').textContent = getFormatLabel(df) + ' HH:mm';
      $('hint_input').innerHTML = t.text_hint.replace('{fmt}', `<span class="badge mono">${getFormatLabel(df)} HH:mm</span>`);
      $('input_err').textContent = t.text_err.replace('{fmt}', getFormatLabel(df) + ' HH:mm');
    }

    // Picker
    function rebuildPicker(){
      const df = getActiveDf();
      const box = $('datePicker');
      const d = parseISOToUTC(state.utcISO) || new Date();
      const Y = d.getUTCFullYear();
      const M = d.getUTCMonth()+1;
      const D = d.getUTCDate();
      box.innerHTML='';

      const selDay = buildSelect(1, 31, D, 'dd');
      const selMon = buildSelect(1, 12, M, 'mm');
      const selYear = buildRangeSelect(Y-5, Y+5, Y, 'yyyy');

      selDay.addEventListener('change', onPickerChange);
      selMon.addEventListener('change', onPickerChange);
      selYear.addEventListener('change', onPickerChange);

      const sep=(s)=>{ const span=document.createElement('span'); span.className='sep'; span.textContent=s; return span; };
      if (df===DF.MDY){
        box.append(selMon, sep('/'), selDay, sep('/'), selYear);
      } else if (df===DF.DMY){
        box.append(selDay, sep('/'), selMon, sep('/'), selYear);
      } else if (df===DF.DMY_DOT){
        box.append(selDay, sep('.'), selMon, sep('.'), selYear);
      } else if (df===DF.YMD){
        box.append(selYear, sep('-'), selMon, sep('-'), selDay);
      }

      fillTimeSelect($('hh'), 0, 23, d.getUTCHours());
      fillTimeSelect($('mm'), 0, 59, d.getUTCMinutes());
      $('hh').removeEventListener('change', onPickerChange); $('hh').addEventListener('change', onPickerChange);
      $('mm').removeEventListener('change', onPickerChange); $('mm').addEventListener('change', onPickerChange);
    }
    function buildSelect(from, to, val, cls){
      const s=document.createElement('select'); s.className='field '+cls;
      for (let i=from;i<=to;i++){ const o=document.createElement('option'); const v=String(i).padStart(2,'0'); o.value=v; o.textContent=v; if (i===val) o.selected=true; s.appendChild(o); }
      return s;
    }
    function buildRangeSelect(from, to, val, cls){
      const s=document.createElement('select'); s.className='field '+cls;
      for (let i=from;i<=to;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=String(i); if (i===val) o.selected=true; s.appendChild(o); }
      return s;
    }
    function fillTimeSelect(sel, from, to, cur){ sel.innerHTML=''; for(let i=from;i<=to;i++){ const o=document.createElement('option'); const v=String(i).padStart(2,'0'); o.value=v; o.textContent=v; if (i===cur) o.selected=true; sel.appendChild(o);} }
    function onPickerChange(){
      const picks = $('datePicker').querySelectorAll('select');
      const hh=$('hh').value||'00', mm=$('mm').value||'00';
      const df = getActiveDf();
      let DD, MM, YYYY;
      if (df===DF.MDY){ MM=picks[0].value; DD=picks[1].value; YYYY=picks[2].value; }
      else if (df===DF.DMY){ DD=picks[0].value; MM=picks[1].value; YYYY=picks[2].value; }
      else if (df===DF.DMY_DOT){ DD=picks[0].value; MM=picks[1].value; YYYY=picks[2].value; }
      else if (df===DF.YMD){ YYYY=picks[0].value; MM=picks[1].value; DD=picks[2].value; }
      state.utcISO = `${YYYY}-${MM}-${DD}T${hh}:${mm}`;
      syncTextFromISO();
      renderOutput();
    }

    // Text input
    function onManualInputMask(e){
      const raw = e.target.value;
      const isoLike = raw.replace(' ','T').slice(0,16);
      if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(isoLike)) {
        state.utcISO = isoLike; syncPickerFromISO(); renderOutput(); return;
      }
      const digits = raw.replace(/\D/g,'');
      const df = getActiveDf();
      let out='';
      if (df===DF.MDY){
        if (digits.length>0) out += digits.slice(0,2);
        if (digits.length>=3) out += '/' + digits.slice(2,4);
        if (digits.length>=5) out += '/' + digits.slice(4,8);
        if (digits.length>=9) out += ' ' + digits.slice(8,10);
        if (digits.length>=11) out += ':' + digits.slice(10,12);
      } else if (df===DF.DMY){
        if (digits.length>0) out += digits.slice(0,2);
        if (digits.length>=3) out += '/' + digits.slice(2,4);
        if (digits.length>=5) out += '/' + digits.slice(4,8);
        if (digits.length>=9) out += ' ' + digits.slice(8,10);
        if (digits.length>=11) out += ':' + digits.slice(10,12);
      } else if (df===DF.DMY_DOT){
        if (digits.length>0) out += digits.slice(0,2);
        if (digits.length>=3) out += '.' + digits.slice(2,4);
        if (digits.length>=5) out += '.' + digits.slice(4,8);
        if (digits.length>=9) out += ' ' + digits.slice(8,10);
        if (digits.length>=11) out += ':' + digits.slice(10,12);
      } else if (df===DF.YMD){
        if (digits.length>0) out += digits.slice(0,4);
        if (digits.length>=5) out += '-' + digits.slice(4,6);
        if (digits.length>=7) out += '-' + digits.slice(6,8);
        if (digits.length>=9) out += ' ' + digits.slice(8,10);
        if (digits.length>=11) out += ':' + digits.slice(10,12);
      }
      e.target.value = out;
      const d = parseByFormat(out, df) || parseFallbacks(out);
      if (d){ state.utcISO = toISO_UTC_Min(d); syncPickerFromISO(); }
      renderOutput();
    }

    // Sync from canonical UTC
    function syncPickerFromISO(){
      const d = parseISOToUTC(state.utcISO);
      if (!d) return;
      const df = getActiveDf();
      if (!$('datePicker').children.length) rebuildPicker();
      const picks = $('datePicker').querySelectorAll('select');
      const YYYY=d.getUTCFullYear(), MM=String(d.getUTCMonth()+1).padStart(2,'0'), DD=String(d.getUTCDate()).padStart(2,'0');
      if (df===DF.MDY){ picks[0]&&(picks[0].value=MM); picks[1]&&(picks[1].value=DD); picks[2]&&(picks[2].value=String(YYYY)); }
      else if (df===DF.DMY || df===DF.DMY_DOT){ picks[0]&&(picks[0].value=DD); picks[1]&&(picks[1].value=MM); picks[2]&&(picks[2].value=String(YYYY)); }
      else if (df===DF.YMD){ picks[0]&&(picks[0].value=String(YYYY)); picks[1]&&(picks[1].value=MM); picks[2]&&(picks[2].value=DD); }
      $('hh').value = String(d.getUTCHours()).padStart(2,'0');
      $('mm').value = String(d.getUTCMinutes()).padStart(2,'0');
    }
    function syncTextFromISO(){
      const d = parseISOToUTC(state.utcISO);
      if (!d) return;
      $('utcInput').value = toByDf(d, getActiveDf());
    }

    // Output + countdown
    function renderOutput(){
      markTZ();
      const t = DICT[state.lang] || DICT['en'];
      $('title').textContent = t.title; document.title=t.title;
      $('note').textContent = t.note;
      $('title_conv').textContent = t.conv;
      $('title_setup').textContent = t.setup;
      $('label_input').textContent = t.input_label;
      $('hint_picker').textContent = t.picker_hint;
      $('label_result').firstChild.nodeValue = t.result + ' ';
      $('label_now').textContent = t.current_time;
      $('label_share').textContent = t.share;
      $('label_lang').textContent = t.lang_label;
      $('hint_lang').textContent = t.lang_hint;
      $('label_df').textContent = t.df_label;
      $('hint_df').textContent = t.df_hint;
      $('tabPicker').textContent = t.tab_picker;
      $('tabText').textContent = t.tab_text;
      $('tzSearch').placeholder = t.search_placeholder;
      $('btnAuto').textContent = t.auto_btn;

      const d = parseISOToUTC(state.utcISO);
      $('outLocal').textContent = d ? formatInTZ(d, state.tz, state.lang) : '‚Äî';
      $('outTz').textContent=state.tz;
      $('outNow').textContent = formatInTZ(new Date(), state.tz, state.lang);
      $('share').textContent = shareURL();
      updateCountdown();
      try { history.replaceState(null, '', shareURL()); } catch {}
    }
    function updateNow(){ $('outNow').textContent = formatInTZ(new Date(), state.tz, state.lang); }
    function updateCountdown(){
      const d = parseISOToUTC(state.utcISO);
      const el = $('countdown');
      if (!d){ el.textContent=''; return; }
      const now = new Date();
      let diff = Math.floor((d.getTime() - now.getTime())/1000); // seconds
      const t = DICT[state.lang] || DICT['en'];
      if (Math.abs(diff) < 1){ el.textContent = t.now; return; }
      const past = diff < 0;
      diff = Math.abs(diff);
      const dd = Math.floor(diff/86400); diff %= 86400;
      const hh = Math.floor(diff/3600); diff %= 3600;
      const mm = Math.floor(diff/60); const ss = diff%60;
      const parts = [];
      if (dd) parts.push(dd+' –¥');
      if (hh || dd) parts.push(hh.toString().padStart(2,'0')+' —á');
      parts.push(mm.toString().padStart(2,'0')+' –º');
      parts.push(ss.toString().padStart(2,'0')+' —Å');
      el.innerHTML = (past ? t.passed : t.left) + ': <strong>' + parts.join(' ') + '</strong>';
    }

    // Share URL
    function shareURL(){
      const u = new URL(location.href);
      const d = parseISOToUTC(state.utcISO);
      if (d) u.searchParams.set('utc', state.utcISO); else u.searchParams.delete('utc');
      u.searchParams.set('tz', state.tz);
      u.searchParams.set('lang', state.lang);
      u.searchParams.set('df', state.dateFormat);
      return u.toString();
    }

    // Utils
    function isoNowUTCMin(){
      const now=new Date(); const ms=60000; const t=Math.floor(now.getTime()/ms)*ms; const d=new Date(t);
      return toISO_UTC_Min(d);
    }
    function toISO_UTC_Min(date){
      const pad=(n)=>String(n).padStart(2,'0');
      const y=date.getUTCFullYear(), m=pad(date.getUTCMonth()+1), dd=pad(date.getUTCDate()), hh=pad(date.getUTCHours()), mm=pad(date.getUTCMinutes());
      return `${y}-${m}-${dd}T${hh}:${mm}`;
    }
    function parseISOToUTC(txt){
      const s=(txt||'').replace(' ','T').slice(0,16);
      if (!/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(s)) return null;
      const [d,t]=s.split('T'); const [y,m,dd]=d.split('-').map(Number); const [hh,mm]=t.split(':').map(Number);
      return new Date(Date.UTC(y,(m||1)-1,dd||1,hh||0,mm||0,0,0));
    }
    function toByDf(date, df){
      const pad=(n)=>String(n).padStart(2,'0');
      const YYYY=date.getUTCFullYear(), MM=pad(date.getUTCMonth()+1), DD=pad(date.getUTCDate()), hh=pad(date.getUTCHours()), mm=pad(date.getUTCMinutes());
      if (df===DF.MDY) return `${MM}/${DD}/${YYYY} ${hh}:${mm}`;
      if (df===DF.DMY) return `${DD}/${MM}/${YYYY} ${hh}:${mm}`;
      if (df===DF.DMY_DOT) return `${DD}.${MM}.${YYYY} ${hh}:${mm}`;
      if (df===DF.YMD) return `${YYYY}-${MM}-${DD} ${hh}:${mm}`;
      return `${DD}/${MM}/${YYYY} ${hh}:${mm}`;
    }
    function formatInTZ(date, tz, lang){
      try { return new Intl.DateTimeFormat(lang, { timeZone: tz, year:'numeric', month:'long', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:false, weekday:'short', timeZoneName:'short' }).format(date); }
      catch { return date.toUTCString(); }
    }
    function getInitialLang(){
      const urlLang = new URL(location.href).searchParams.get('lang');
      if (urlLang && SUPPORTED.includes(urlLang)) return urlLang;
      const saved = localStorage.getItem('calc_lang');
      if (saved && SUPPORTED.includes(saved)) return saved;
      const browser = (navigator.language || 'ru').slice(0,2);
      return SUPPORTED.includes(browser) ? browser : 'ru';
    }
    function applyLang(){ /* labels handled in renderOutput(); masks in updateMaskBadge() */ }

    function readQuery(){
      const u=new URL(location.href);
      const qUtc=u.searchParams.get('utc');
      const qTz=u.searchParams.get('tz');
      const qLang=u.searchParams.get('lang');
      const qDf=u.searchParams.get('df');
      if (qTz && allZones().includes(qTz)) state.tz=qTz;
      if (qLang && SUPPORTED.includes(qLang)) state.lang=qLang;
      if (qDf && Object.values(DF).includes(qDf)) state.dateFormat=qDf;
      if (qUtc){
        const d=parseISOToUTC(qUtc);
        if (d){ state.utcISO=qUtc.slice(0,16); }
      }
      $('lang').value=state.lang; $('dateFormat').value=state.dateFormat;
    }

    // Kick off
    init();
  </script>
</body>
</html>
